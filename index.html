<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Live-MusikwÃ¼nsche</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap');
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Montserrat', sans-serif;
    background-color: #000;
    color: #fff;
    overflow: hidden;
  }
  body {
    display: flex;
    flex-direction: row;
    height: 100vh;
    padding: 2rem;
    position: relative;
  }
  h1 {
    font-size: 3rem;
    text-align: center;
    width: 100%;
    margin-bottom: 2rem;
    user-select: none;
    text-shadow: 0 0 10px #00ffffaa;
  }

  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #wunschListe {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 1rem;
    scrollbar-width: thin;
    scrollbar-color: #00ffff55 transparent;
  }
  #wunschListe::-webkit-scrollbar {
    width: 8px;
  }
  #wunschListe::-webkit-scrollbar-thumb {
    background: #00ffff55;
    border-radius: 4px;
  }

  .song {
    position: relative;
    background: #111;
    margin: 1rem 0;
    padding: 1.5rem 2rem;
    border-radius: 16px;
    box-shadow: 0 0 15px #00ffff88;
    font-size: 2.2rem;
    opacity: 0;
    animation: fadeIn 0.8s forwards;
    user-select: none;
  }
  .song strong {
    font-size: 2.8rem;
    display: block;
    margin-bottom: 0.3rem;
    color: #00ffff;
  }
  .song em {
    font-style: normal;
    font-size: 2rem;
    color: #ccc;
    display: block;
    margin-bottom: 0.5rem;
  }
  .song small {
    font-size: 1.4rem;
    color: #666;
    user-select: text;
  }

  /* X-Button */
  .btn-remove {
    position: absolute;
    right: 1rem;
    top: 1rem;
    background: #ff0044;
    border: none;
    border-radius: 50%;
    width: 2.8rem;
    height: 2.8rem;
    color: white;
    font-weight: bold;
    font-size: 2rem;
    line-height: 1;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.3s ease;
    user-select: none;
  }
  .btn-remove:hover {
    opacity: 1;
  }

  /* Sidebar */
  #sidebar {
    width: 360px;
    margin-left: 3rem;
    border-left: 2px solid #00ffff55;
    padding-left: 2rem;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }
  #sidebar h2 {
    font-size: 2.8rem;
    margin-bottom: 1.5rem;
    color: #00ffff;
    user-select: none;
  }
  .top-song {
    background: #111;
    margin-bottom: 1rem;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 0 10px #00ffff88;
    font-size: 2rem;
    user-select: none;
  }
  .top-song strong {
    font-size: 2.4rem;
    color: #00ffff;
  }
  .top-song em {
    font-style: normal;
    color: #ccc;
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }

  /* Infobanner oben */
  #infoBanner {
    position: fixed;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: #00ffffdd;
    color: #000;
    padding: 1rem 2rem;
    border-radius: 12px;
    box-shadow: 0 0 15px #00ffffaa;
    font-size: 2rem;
    min-width: 300px;
    max-width: 600px;
    text-align: center;
    z-index: 1000;
    display: none; /* nur sichtbar wenn infos da sind */
  }
  #infoBanner strong {
    display: block;
    font-size: 2.4rem;
    margin-bottom: 0.3rem;
  }

  /* QR-Code rechts unten */
  #qrCodeContainer {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background: #000a;
    padding: 1rem;
    border-radius: 16px;
    box-shadow: 0 0 10px #00ffffaa;
    user-select: none;
  }
  #qrCodeContainer img {
    width: 120px;
    height: 120px;
    display: block;
  }
  #qrCodeContainer p {
    margin: 0;
    margin-top: 0.5rem;
    color: #00ffff;
    font-size: 1.4rem;
    text-align: center;
  }
</style>
</head>
<body>

  <div id="main">
    <h1>ðŸŽ¶ Eure MusikwÃ¼nsche ðŸŽ¶</h1>
    <div id="wunschListe">Wird geladenâ€¦</div>
  </div>

  <aside id="sidebar">
    <h2>Top 3 WÃ¼nsche</h2>
    <div id="top3">Wird geladenâ€¦</div>
  </aside>

  <!-- Infobanner -->
  <div id="infoBanner"><strong></strong><span></span></div>

  <!-- QR-Code unten rechts -->
  <div id="qrCodeContainer" title="Zum Voting-Formular">
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://dein-voting-formular-link.de" alt="QR-Code zum Voting" />
    <p>Hier voten!</p>
  </div>

<script>
  const sheetId = "1fDn-x08SRqSKojZMaQui3-8-Uxs6MoaG3dgTTMtjdJs";
  const sheetName = "Formularantworten 1";
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

  const infosUrl = "infos.txt"; // Pfad zur Textdatei mit Infos

  const STORAGE_KEY = "gespielteSongs";

  function holeGespielteSongs() {
    const json = localStorage.getItem(STORAGE_KEY);
    if (!json) return [];
    try {
      return JSON.parse(json);
    } catch {
      return [];
    }
  }
  function speichereGespielteSongs(arr) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }
  function markiereGespielt(index) {
    const gespielt = holeGespielteSongs();
    if (!gespielt.includes(index)) {
      gespielt.push(index);
      speichereGespielteSongs(gespielt);
    }
    ladeWuensche();
  }

  function erstelleSongElement(row, index, animationDelay) {
    const zeit = row.c[0]?.f || "";
    const titel = row.c[3]?.v || "ðŸŽµ unbekannter Titel";
    const kuenstler = row.c[4]?.v || "ðŸ‘¤ unbekannter KÃ¼nstler";

    const div = document.createElement("div");
    div.className = "song";
    div.style.animationDelay = animationDelay + "s";
    div.setAttribute("data-index", index);

    div.innerHTML = `
      <strong>${titel}</strong>
      <em>${kuenstler}</em>
      <small>${zeit}</small>
      <button class="btn-remove" title="Als gespielt markieren">&times;</button>
    `;

    div.querySelector(".btn-remove").addEventListener("click", (e) => {
      e.stopPropagation();
      markiereGespielt(index);
    });

    return div;
  }

  function ermittleTop3(rows, gespieltArr) {
    const counts = {};
    rows.forEach((row, idx) => {
      if (gespieltArr.includes(idx)) return;
      const titel = row.c[3]?.v || "";
      const kuenstler = row.c[4]?.v || "";
      if (!titel) return;
      const key = `${titel}###${kuenstler}`;
      counts[key] = (counts[key] || 0) + 1;
    });
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    return sorted.slice(0,3).map(([key, count]) => {
      const [titel, kuenstler] = key.split("###");
      return { titel, kuenstler, count };
    });
  }

  function renderTop3(top3) {
    const container = document.getElementById("top3");
    container.innerHTML = "";
    if (top3.length === 0) {
      container.innerHTML = "<p>Keine WÃ¼nsche vorhanden.</p>";
      return;
    }
    top3.forEach(({titel, kuenstler, count}) => {
      const div = document.createElement("div");
      div.className = "top-song";
      div.innerHTML = `<strong>${titel}</strong><br><em>${kuenstler}</em><br><small>Stimmen: ${count}</small>`;
      container.appendChild(div);
    });
  }

  // Scrollen in Wunschliste
  let scrollInterval;
  function startScroll(container) {
    clearInterval(scrollInterval);
    if (container.scrollHeight <= container.clientHeight) return; // Kein Scroll nÃ¶tig

    let pos = 0;
    let dir = 1;
    scrollInterval = setInterval(() => {
      pos += dir;
      container.scrollTop = pos;
      if (pos + container.clientHeight >= container.scrollHeight) dir = -1;
      else if (pos <= 0) dir = 1;
    }, 50);
  }

  // --- Infobanner Logik ---

  let infos = [];
  let currentInfoIndex = 0;
  let infoTimeout;

  async function ladeInfos() {
    try {
      const res = await fetch(infosUrl + "?_=" + Date.now());
      if (!res.ok) throw new Error("Keine Infos");

      const text = await res.text();
      const lines = text.split("\n").map(l => l.trim()).filter(l => l.length > 0);

      infos = lines.map(line => {
        const [titel, nachricht] = line.split(",", 2);
        return { titel: titel || "", nachricht: nachricht || "" };
      }).filter(info => info.titel && info.nachricht);

      if (infos.length > 0) {
        zeigeInfo(infos[0]);
        if (infos.length > 1) {
          clearTimeout(infoTimeout);
          infoTimeout = setInterval(() => {
            currentInfoIndex = (currentInfoIndex + 1) % infos.length;
            zeigeInfo(infos[currentInfoIndex]);
          }, 30000); // alle 30s wechseln
        }
      } else {
        verbergeInfo();
      }
    } catch (err) {
      verbergeInfo();
      console.warn("Info-Banner konnte nicht geladen werden:", err);
    }
  }

  function zeigeInfo(info) {
    const banner = document.getElementById("infoBanner");
    banner.querySelector("strong").textContent = info.titel;
    banner.querySelector("span").textContent = info.nachricht;
    banner.style.display = "block";
  }
  function verbergeInfo() {
    const banner = document.getElementById("infoBanner");
    banner.style.display = "none";
    clearInterval(infoTimeout);
  }

  // Hauptfunktion zum Laden aller Daten
  async function ladeWuensche() {
    try {
      const res = await fetch(url + "&_=" + Date.now());
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0, -2));
      const rows = json.table.rows;

      const container = document.getElementById("wunschListe");
      container.innerHTML = "";

      const gespielt = holeGespielteSongs();

      // WÃ¼nsche anzeigen, nur wenn nicht gespielt
      rows.slice().reverse().forEach((row, idx) => {
        const indexImOriginal = rows.length - 1 - idx;
        if (gespielt.includes(indexImOriginal)) return;

        const animationDelay = idx * 0.15;
        const songEl = erstelleSongElement(row, indexImOriginal, animationDelay);
        container.appendChild(songEl);
      });

      const top3 = ermittleTop3(rows, gespielt);
      renderTop3(top3);

      startScroll(container);

      // Neue Infos laden
      ladeInfos();
    } catch (err) {
      const container = document.getElementById("wunschListe");
      container.innerHTML = "Fehler beim Laden.";
      console.error("Fehler beim Laden der Tabelle:", err);
    }
  }

  ladeWuensche();
  setInterval(ladeWuensche, 30000);

</script>
</body>
</html>
